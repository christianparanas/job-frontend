<!-- pathway.component.html -->
<div class="relative z-40 mt-20 pb-20">
  <div class="mb-5">
    <h1 class="font-bold text-xl md:text-3xl text-gray-900">Your Career Pathway</h1>
    <p class="text-gray-800 text-[12px]">
      Explore your career progression based on your skills. Click on a role to view details.
    </p>
  </div>

  <hr />

  <!-- Loading and Error States -->
  <div *ngIf="!isPathwayLoaded && !error" class="text-center text-gray-600">
    <svg class="animate-spin h-5 w-5 text-gray-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
    </svg>
    Loading career pathway...
  </div>
  <div *ngIf="error" class="text-center text-red-600">
    {{ error }}
  </div>

  <!-- Pathway Visualization -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-0 py-8" *ngIf="isPathwayLoaded">
    <div class="flex">
      <!-- SVG Pathway -->
      <div class="flex-1">
        <svg xmlns="http://www.w3.org/2000/svg" width="600" height="600" class="border">
          <!-- Draw connections (arrows) between roles -->
          <g fill="none" stroke="#000" stroke-width="2">
            <ng-container *ngFor="let connection of connections">
              <ng-container *ngIf="getNodePosition(connection.from) as fromPos">
                <ng-container *ngIf="getNodePosition(connection.to) as toPos">
                  <path
                    [attr.d]="
                      'M' +
                      (fromPos.x) +
                      ',' +
                      (fromPos.y + 30) +
                      ' L' +
                      (toPos.x) +
                      ',' +
                      (toPos.y - 30)
                    "
                    marker-end="url(#arrow)"
                  />
                </ng-container>
              </ng-container>
            </ng-container>
          </g>

          <!-- Define arrow marker -->
          <defs>
            <marker
              id="arrow"
              markerWidth="10"
              markerHeight="10"
              refX="8"
              refY="3"
              orient="auto"
              markerUnits="strokeWidth"
            >
              <path d="M0,0 L0,6 L9,3 z" fill="#000" />
            </marker>
          </defs>

          <!-- Draw nodes (roles) as rectangles -->
          <g *ngFor="let node of nodePositions">
            <!-- Rectangle for the role -->
            <rect
              [attr.x]="node.x - 80"
              [attr.y]="node.y - 20"
              width="160"
              height="40"
              rx="5"
              [ngClass]="{
                'fill-green-300': pathway[node.roleKey].isEligible,
                'fill-yellow-300': !pathway[node.roleKey].isEligible && pathway[node.roleKey].missingSkills.length > 0,
                'fill-gray-300': !pathway[node.roleKey].isEligible && pathway[node.roleKey].missingSkills.length === pathway[node.roleKey].requirements.length
              }"
              stroke="#000"
              stroke-width="1"
              class="cursor-pointer"
              (click)="selectRole(node.roleKey)"
            />
            <!-- Text inside the rectangle -->
            <text
              [attr.x]="node.x"
              [attr.y]="node.y + 5"
              text-anchor="middle"
              alignment-baseline="middle"
              class="text-sm text-gray-700"
            >
              {{ pathway[node.roleKey].role }}
            </text>
          </g>
        </svg>
      </div>

      <!-- Details Panel -->
      <div class="w-1/3 pl-4" *ngIf="selectedRole">
        <div class="p-4 rounded-lg shadow-sm border bg-white">
          <h4 class="font-medium text-gray-900">{{ selectedRole.role }}</h4>
          <p class="text-sm text-gray-600">Level: {{ selectedRole.level }}</p>
          <p class="text-sm text-gray-600">
            Status: {{ selectedRole.isEligible ? 'Eligible' : 'Not Eligible' }}
          </p>
          <div *ngIf="!selectedRole.isEligible && selectedRole.missingSkills.length > 0">
            <p class="text-sm text-gray-600">Skills to Improve:</p>
            <ul class="list-disc list-inside text-sm text-gray-600">
              <li *ngFor="let skill of selectedRole.missingSkills">
                {{ skill.skill }} (Current: {{ skill.userLevel }} / Required: {{ skill.requiredLevel }})
              </li>
            </ul>
          </div>
          <div class="mt-2">
            <p class="text-sm text-gray-600">
              Progress: {{ (selectedRole.requirements.length - selectedRole.missingSkills.length) / selectedRole.requirements.length * 100 | number: '1.0-0' }}%
            </p>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
              <div
                class="bg-blue-600 h-2.5 rounded-full"
                [style.width]="(selectedRole.requirements.length - selectedRole.missingSkills.length) / selectedRole.requirements.length * 100 + '%'"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
